points(getCoords(x),col=dispRes,pch=15,cex=1)
points(hgdp,col.node="blue") # show the NA -> these are pop from hgdp

load(paste("outputs/path",which.min(res),".RData",sep=""))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
title("'worst' result")

par(mar=c(0,0,2,0))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
title("'worst' result")

points(hgdp)
points(hgdp,col.node=TRUE)
points(hgdp,col.node="black")
head(names(myPath))
sub(":.*","",names(myPath)[1])
points(getNodes(x)[ori,],pch="x")
ori <- sub(":.*","",names(myPath)[1])
points(getNodes(x)[ori,],pch="x")

x
points(getCoords(x)[ori,],pch="x")

ori
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,],pch="x", cex=2)
title("'worst' result")

ori
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2)

plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2,col="red")
title("'worst' result")

load(paste("outputs/path0",which.max(res),".RData",sep=""))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2,col="red")
title("'best' result")


ori
load(paste("outputs/path",which.min(res),".RData",sep=""))
par(mar=c(0,0,2,0))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2,col="red")
title("'worst' result")
ori
load(paste("outputs/path0",which.max(res),".RData",sep=""))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2,col="red")
title("'best' result")

load(paste("outputs/path0",which.max(res),".RData",sep=""))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2,col="red")
title("'best' result")

load(paste("outputs/path",which.min(res),".RData",sep=""))
par(mar=c(0,0,2,0))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2,col="red")
title("'worst' result")

load(paste("outputs/path0",which.max(res),".RData",sep=""))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2,col="red")
title("'best' result")

par(mar=c(0,0,2,0))
plot(worldgraph.40k,res=TRUE, col=0)
plot(myPath,seed=1)
points(hgdp,col.node="black")
ori <- sub(":.*","",names(myPath)[1])
points(getCoords(x)[ori,1],getCoords(x)[ori,2],pch="x", cex=2,col="red")
title("'best' result")

hist(res, col="grey")

hist(res, col="grey", main="R2 histogram")
hist(res, col="grey", main="Histogram of R2")
plot(1:100,col=1:100)
range(res,na.rm=T)
length(res)
which(is.na(res))
load("/home/master/dev/geograph/pkg/misc/simulations/outputs/path0036.RData")
head(myPath)
sapply(myPath, function(e) e$length)
sapply(myPath[-length(myPath)], function(e) e$length)
worldgraph.40k@meta$costs
which.max(res)
worldgraph.40k <- setFriction(worldgraph.40k, node.cost=1)
table(getCosts(worldgraph.40k))
table(getCosts(worldgraph.40k,res="vecto"))
temp <- dijkstraFrom(hgdp, "16074")
plot(worldgraph.40k,col=0)
plot(temp)
geo.dist <- sapply(temp[-length(temp)], function(e) e$length)
geo.dist
cor(geo.dist,hgdp@data$Genetic.Div)
cor(geo.dist,hgdp@data$Genetic.Div)^2
plot(geo.dist~hgdp@data$Genetic.Div)
plot(geo.dist,hgdp@data$Genetic.Div)
plot(log(geo.dist),hgdp@data$Genetic.Div)
plot(geo.dist,log(hgdp@data$Genetic.Div))
plot(geo.dist,hgdp@data$Genetic.Div)
range(res)
range(res,TRUE)
range(res,na.rm=T)
q()
n
library(geoGraph)
data(hgdp)
data(worldgraph.40k)

setwd("/home/master/dev/geograph/pkg/misc/simulations/")
source("doSimul.R")



##
## COMPUTE COSTS
##

## turn productivity into costs (range: 0-100)
myCosts1 <- getNodesAttr(worldgraph.40k)$meanProd
myCosts1 <- max(myCosts1) - myCosts1
range(myCosts1)
myCosts1 <- 100*myCosts1/max(myCosts1) # range 0 - 100
range(myCosts1)
hist(myCosts1, col="grey")


## turn var of productivity into costs (range: 0-100)
myCosts2 <- getNodesAttr(worldgraph.40k)$varProd
myCosts2 <- 100*(myCosts2 +1)/max(myCosts2 +1 ) # range 0 - 100
range(myCosts2)
hist(myCosts2, col="grey")


## merge both
myCosts <- (myCosts1 + myCosts2)/2
myCosts <- 100* myCosts /max(myCosts)
hist(myCosts, col="grey")
myCol <- round((100-myCosts)/100, 10)
myCol <- gray(myCol)
myCol[worldgraph.40k@nodes.attr$sea] <- rgb(1,1,1,1)
plot(worldgraph.40k, col=myCol)


## set costs for special habitats
myCosts[worldgraph.40k@nodes.attr$sea] <- 1e10
myCosts[worldgraph.40k@nodes.attr$deselected.land] <- 1e10
myCosts[worldgraph.40k@nodes.attr$landbridge] <- 100


## set costs
worldgraph.40k <- setFriction(worldgraph.40k, node.costs=myCosts)
worldgraph.40k <- dropDeadEdges(worldgraph.40k, thres=2e5)

isConnected(hgdp)

addis <- list(lon=38.74,lat=9.03)
addis <- closestNode(worldgraph.40k,addis) # this takes a while
doSimul(addis,hgdp, ".") # result: R2=0.7946

temp <- expand.grid(seq(-30,60,by=5), seq(-40,40,by=5))
x <- closestNode(worldgraph.40k,temp) # this takes a while

conCom <- connectedComp(getGraph(worldgraph.40k)) # get connected sets
conCom <- conCom[order(sapply(conCom,length),decreasing=TRUE)] # sort by decr. size
conCom <- conCom[[1]]
myCandidates <- intersect(x,conCom) # retained candidates
length(myCandidates)

temp <- findInLayer(getCoords(worldgraph.40k)[myCandidates,], attr="CONTINENT")
myCandidates <- row.names(temp[temp=="Africa",,drop=FALSE]) # keep nodes in Africa
plot(worldgraph.40k)
points(getCoords(worldgraph.40k)[myCandidates,])

res <- doSimul(myCandidates, hgdp, "outputs") # this can take hours (3 sim/minute)

range(res)
load("/home/master/dev/geograph/pkg/misc/productivity/gpp.RData")
dispRes <- res - min(res,na.rm=TRUE)
dispRes <- 1 + (99*dispRes/max(dispRes,na.rm=T))
range(dispRes,na.rm=T)

x <- worldgraph.40k[myCandidates]

plot(x,reset=TRUE)
palette(heat.colors(105))
points(getCoords(x),col=dispRes,pch=15,cex=1)
points(hgdp,col.node="blue") # show the NA -> these are pop from hgdp

q()
n
